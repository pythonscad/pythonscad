name: Build and Upload AppImage

on:
  release:
    types: [created]
  workflow_dispatch:
    inputs:
      upload_to_release:
        description: 'Release tag to upload to (leave empty for test build)'
        required: false
        default: ''
      debug_enabled:
        type: boolean
        description: 'Run the build with tmate debugging enabled (https://github.com/marketplace/actions/debugging-with-tmate)'
        required: false
        default: false

jobs:
  build-appimage:
    name: Build AppImage (Qt${{ matrix.qt_version }} / ${{ matrix.arch }})
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        qt_version: [5, 6]
        arch: [x86_64, aarch64]
        include:
          - qt_version: 5
            profile: pythonscad-qt5
          - qt_version: 6
            profile: pythonscad-qt6
          # Use Docker container for ARM64 builds
          - arch: aarch64
            docker_image: ubuntu:24.04
            platform: linux/arm64
          # Native build for x86_64 (no container needed)
          - arch: x86_64
            docker_image: null
            platform: linux/amd64

    container: ${{ matrix.docker_image }}

    steps:
    - name: Ensure git is available and configure
      if: matrix.docker_image
      run: |
        apt-get update
        apt-get install -y git ca-certificates
        git config --global --add safe.directory '*'

    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: 'recursive'

    - name: Fetch tags for version detection
      run: |
        git fetch --unshallow --tags || git fetch --tags
        git describe --tags --always --dirty

    - name: Setup (detached) tmate session if enabled
      if: ${{ github.event_name == 'workflow_dispatch' && inputs.debug_enabled }}
      uses: mxschmitt/action-tmate@v3
      timeout-minutes: 5
      with:
        detached: true
        limit-access-to-actor: true

    - name: Set up QEMU for ARM64
      if: matrix.arch == 'aarch64' && !matrix.docker_image
      uses: docker/setup-qemu-action@v3
      with:
        platforms: arm64

    - name: Install dependencies (native runner)
      if: '!matrix.docker_image'
      env:
        DEBIAN_FRONTEND: noninteractive
        TZ: Etc/UTC
      run: |
        sudo apt-get update
        sudo -E ./scripts/uni-get-dependencies.py --yes --profile ${{ matrix.profile }}
        sudo apt-get install -y wget file libfuse2

    - name: Install dependencies (Docker container)
      if: matrix.docker_image
      env:
        DEBIAN_FRONTEND: noninteractive
        TZ: Etc/UTC
      run: |
        apt-get update
        # Install git and Python first (needed for uni-get-dependencies)
        apt-get install -y git python3
        # Install build dependencies (running as root, no sudo needed)
        ./scripts/uni-get-dependencies.py --yes --profile ${{ matrix.profile }}
        # Install additional AppImage dependencies
        apt-get install -y wget file libfuse2

    - name: Build AppImage
      env:
        QT_VERSION: ${{ matrix.qt_version }}
        ARCH: ${{ matrix.arch }}
      run: |
        chmod +x ./scripts/create_appimage.sh
        ./scripts/create_appimage.sh

    - name: Get AppImage filename
      id: appimage
      run: |
        APPIMAGE_FILE=$(ls dist/PythonSCAD-*.AppImage | head -1)
        echo "filename=$(basename ${APPIMAGE_FILE})" >> $GITHUB_OUTPUT
        echo "filepath=${APPIMAGE_FILE}" >> $GITHUB_OUTPUT

    - name: Upload AppImage as artifact
      uses: actions/upload-artifact@v4
      with:
        name: pythonscad-qt${{ matrix.qt_version }}-${{ matrix.arch }}-appimage
        path: ${{ steps.appimage.outputs.filepath }}
        retention-days: 30

    - name: Upload AppImage to release
      if: github.event_name == 'release' || github.event.inputs.upload_to_release != ''
      uses: softprops/action-gh-release@v2
      with:
        files: ${{ steps.appimage.outputs.filepath }}
        tag_name: ${{ github.event.release.tag_name || github.event.inputs.upload_to_release }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
