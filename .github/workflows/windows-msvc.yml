name: Windows(MSVC) Tests

on:
  pull_request:
  workflow_dispatch:
    inputs:
      debug_enabled:
        type: boolean
        description: 'Run the build with tmate debugging enabled (https://github.com/marketplace/actions/debugging-with-tmate)'
        required: false
        default: false
jobs:
  build-and-test:
    name: windows-latest msvc
    runs-on: windows-latest
    permissions:
      actions: write
      contents: read
    env:
      SCCACHE_DIR: '${{ github.workspace }}\.sccache'
      SCCACHE_CACHE_SIZE: 5G
      RUST_LOG: 'sccache=warn'
      CMAKE_C_COMPILER_LAUNCHER: sccache
      CMAKE_CXX_COMPILER_LAUNCHER: sccache

    strategy:
      fail-fast: false
      matrix:
        build_type: [Release]
        include:
          - build_type: Release
            cmake_preset: windows-msvc-release

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v5
        with:
          submodules: 'recursive'

      - name: Debug - Setup tmate session for 5 minutes
        uses: mxschmitt/action-tmate@v3
        timeout-minutes: 25
        with:
          limit-access-to-actor: true
          detached: true
      - name: Setup Visual Studio Environment
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Install Qt6
        uses: jurplel/install-qt-action@v3
        with:
          version: '6.*'
          host: 'windows'
          target: 'desktop'
          arch: 'win64_msvc2022_64'
          modules: 'qt5compat qtmultimedia'
          cache: true

      - name: Restore QScintilla cache
        id: qscintilla-cache
        uses: actions/cache/restore@v4
        with:
          path: |
            ${{ env.Qt6_DIR }}/lib/qscintilla2_qt6.lib
            ${{ env.Qt6_DIR }}/lib/qscintilla2_qt6.dll
            ${{ env.Qt6_DIR }}/include/Qsci
          key: qscintilla-${{ runner.os }}-2.14.1-qt6.10.0-v2

      - name: Build QScintilla from source
        if: steps.qscintilla-cache.outputs.cache-hit != 'true'
        run: |
          echo === Downloading QScintilla ===
          curl -L -o qscintilla.tar.gz https://www.riverbankcomputing.com/static/Downloads/QScintilla/2.14.1/QScintilla_src-2.14.1.tar.gz
          tar -xzf qscintilla.tar.gz
          cd QScintilla_src-2.14.1\src
          echo.
          echo === Building QScintilla ===
          qmake qscintilla.pro
          nmake
          echo.
          echo === Installing QScintilla ===
          nmake install
          echo SUCCESS: QScintilla built and installed!
        shell: cmd

      - name: Verify QScintilla DLL exports
        if: steps.qscintilla-cache.outputs.cache-hit != 'true'
        shell: cmd
        run: |
          echo === Checking QScintilla DLL exports ===
          echo Checking for QsciScintilla symbols:
          dumpbin /EXPORTS "${{ env.Qt6_DIR }}\lib\qscintilla2_qt6.dll" | findstr /C:"QsciScintilla"
          echo.
          echo Checking for QsciAbstractAPIs symbols:
          dumpbin /EXPORTS "${{ env.Qt6_DIR }}\lib\qscintilla2_qt6.dll" | findstr /C:"QsciAbstractAPIs"
          echo.
          echo Checking for staticMetaObject symbols:
          dumpbin /EXPORTS "${{ env.Qt6_DIR }}\lib\qscintilla2_qt6.dll" | findstr /C:"staticMetaObject"

      - name: Verify QScintilla LIB imports
        if: steps.qscintilla-cache.outputs.cache-hit != 'true'
        shell: cmd
        run: |
          echo === Checking QScintilla .lib file import references ===
          echo Checking for staticMetaObject imports:
          dumpbin /LINKERMEMBER "${{ env.Qt6_DIR }}\lib\qscintilla2_qt6.lib" | findstr /C:"staticMetaObject"
          echo.
          echo Full LINKERMEMBER output (first 100 lines):
          dumpbin /LINKERMEMBER "${{ env.Qt6_DIR }}\lib\qscintilla2_qt6.lib" | head -100

      - name: Check QScintilla DLL dependencies and runtime
        if: steps.qscintilla-cache.outputs.cache-hit != 'true'
        shell: cmd
        run: |
          echo === Checking QScintilla DLL dependencies ===
          dumpbin /DEPENDENTS "${{ env.Qt6_DIR }}\lib\qscintilla2_qt6.dll"
          echo.
          echo === Checking if QScintilla uses debug runtime ===
          dumpbin /IMPORTS "${{ env.Qt6_DIR }}\lib\qscintilla2_qt6.dll" | findstr /C:"MSVCR" /C:"MSVCP" /C:"VCRUNTIME" /C:"UCRTBASE"

      - name: Cleanup QScintilla build artifacts
        if: steps.qscintilla-cache.outputs.cache-hit != 'true'
        run: |
          echo Cleaning up QScintilla build artifacts to reduce cache size...
          rm -rf QScintilla_src-2.14.1
          rm -f qscintilla.tar.gz
          echo Cleanup complete
        shell: bash

      - name: Save QScintilla cache
        if: steps.qscintilla-cache.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: |
            ${{ env.Qt6_DIR }}/lib/qscintilla2_qt6.lib
            ${{ env.Qt6_DIR }}/lib/qscintilla2_qt6.dll
            ${{ env.Qt6_DIR }}/include/Qsci
          key: ${{ steps.qscintilla-cache.outputs.cache-primary-key }}

      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: MSYS
          update: false

      - name: Install flex and bison via pacman
        run: /c/msys64/usr/bin/pacman -Sy --noconfirm flex bison
        shell: bash

      - name: Add MSYS2 to PATH
        run: echo "C:/msys64/usr/bin" >> $GITHUB_PATH
        shell: bash

      - name: Create bsdtar symlink
        run: |
          mklink "C:\Program Files\Git\usr\bin\bsdtar.exe" "C:\Windows\System32\tar.exe" || echo bsdtar symlink already exists
        shell: cmd
        continue-on-error: true

      - name: Install Python Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install bsdiff4 numpy pillow
        shell: cmd

      - name: Restore sccache cache
        id: sccache-cache
        uses: actions/cache/restore@v4
        with:
          path: ${{ env.SCCACHE_DIR }}
          key: sccache-${{ runner.os }}-${{ hashFiles('CMakePresets.json', 'CMakeLists.txt', 'vcpkg.json') }}-${{ github.sha }}
          restore-keys: |
            sccache-${{ runner.os }}-${{ hashFiles('CMakePresets.json', 'CMakeLists.txt', 'vcpkg.json') }}-
            sccache-${{ runner.os }}-

      - name: Install sccache
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $version = '0.7.5'
          $url = "https://github.com/mozilla/sccache/releases/download/v$version/sccache-v$version-x86_64-pc-windows-msvc.zip"
          $zipPath = Join-Path $env:RUNNER_TEMP 'sccache.zip'
          Invoke-WebRequest -Uri $url -OutFile $zipPath
          $extractPath = Join-Path $env:RUNNER_TEMP 'sccache'
          if (Test-Path $extractPath) {
            Remove-Item -Recurse -Force $extractPath
          }
          Expand-Archive -Path $zipPath -DestinationPath $extractPath -Force
          $binary = Get-ChildItem -Path $extractPath -Recurse -Filter 'sccache.exe' | Select-Object -First 1
          if (-not $binary) {
            throw 'sccache.exe not found after extraction.'
          }
          Add-Content -Path $env:GITHUB_PATH -Value $binary.DirectoryName

      - name: Start sccache
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          if (-not (Test-Path $env:SCCACHE_DIR)) {
            New-Item -ItemType Directory -Path $env:SCCACHE_DIR | Out-Null
          }
          sccache --start-server
          sccache --show-stats

      - name: Restore vcpkg binary cache
        id: vcpkg-cache
        uses: actions/cache/restore@v4
        with:
          path: |
            ${{ github.workspace }}/vcpkg
            ~/.cache/vcpkg
            ~/AppData/Local/vcpkg
            ${{ github.workspace }}/vcpkg-cache
          key: vcpkg-${{ runner.os }}-${{ hashFiles('vcpkg.json') }}-${{ hashFiles('vcpkg-configuration.json', '.git/modules/vcpkg/HEAD') }}
          restore-keys: |
            vcpkg-${{ runner.os }}-${{ hashFiles('vcpkg.json') }}-
            vcpkg-${{ runner.os }}-

      - name: Create vcpkg binary cache directory
        run: mkdir -p ${{ github.workspace }}/vcpkg-cache
        shell: bash

      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgDirectory: '${{ github.workspace }}/vcpkg'
          vcpkgGitCommitId: '74e6536215718009aae747d86d84b78376bf9e09'
          vcpkgJsonGlob: '**/vcpkg.json'
          runVcpkgInstall: false
        env:
          VCPKG_BINARY_SOURCES: 'clear;files,${{ github.workspace }}/vcpkg-cache,readwrite'

      - name: Install vcpkg dependencies
        if: steps.vcpkg-cache.outputs.cache-hit != 'true'
        shell: cmd
        run: |
          echo ==============================================================
          echo Installing dependencies from vcpkg.json
          echo ==============================================================
          echo Start time: %TIME%
          echo.
          echo Manifest file contents:
          type vcpkg.json
          echo.
          "${{ github.workspace }}\vcpkg\vcpkg.exe" install --triplet x64-windows
          echo.
          echo End time: %TIME%
          echo.
          echo Installed packages:
          "${{ github.workspace }}\vcpkg\vcpkg.exe" list
          echo ==============================================================
        env:
          VCPKG_BINARY_SOURCES: 'clear;files,${{ github.workspace }}/vcpkg-cache,readwrite'

      - name: Measure vcpkg size before cleanup
        if: steps.vcpkg-cache.outputs.cache-hit != 'true'
        shell: bash
        run: |
          shopt -s nullglob
          echo "=== vcpkg directory sizes BEFORE cleanup ==="
          echo "Checking directories to be cleaned..."
          if [ -d "${{ github.workspace }}/vcpkg/buildtrees" ]; then
            echo "  buildtrees: $(du -sh "${{ github.workspace }}/vcpkg/buildtrees" | cut -f1)"
          else
            echo "  buildtrees: [does not exist]"
          fi
          if [ -d "${{ github.workspace }}/vcpkg/downloads" ]; then
            echo "  downloads: $(du -sh "${{ github.workspace }}/vcpkg/downloads" | cut -f1)"
          else
            echo "  downloads: [does not exist]"
          fi
          if [ -d "${{ github.workspace }}/vcpkg/packages" ]; then
            echo "  packages: $(du -sh "${{ github.workspace }}/vcpkg/packages" | cut -f1)"
          else
            echo "  packages: [does not exist]"
          fi
          echo ""
          if [ -d "${{ github.workspace }}/vcpkg" ]; then
            echo "Total vcpkg size before cleanup: $(du -sh "${{ github.workspace }}/vcpkg" | cut -f1)"
          else
            echo "Total vcpkg size before cleanup: [vcpkg directory not found]"
          fi

      - name: Cleanup vcpkg to reduce cache size
        if: steps.vcpkg-cache.outputs.cache-hit != 'true'
        shell: bash
        run: |
          echo "Cleaning up vcpkg directories to reduce cache size..."
          CLEANED=0
          if [ -d "${{ github.workspace }}/vcpkg/buildtrees" ]; then
            echo "  Removing buildtrees..."
            rm -rf "${{ github.workspace }}/vcpkg/buildtrees"
            CLEANED=1
          else
            echo "  buildtrees: [does not exist, skipping]"
          fi
          if [ -d "${{ github.workspace }}/vcpkg/downloads" ]; then
            echo "  Removing downloads..."
            rm -rf "${{ github.workspace }}/vcpkg/downloads"
            CLEANED=1
          else
            echo "  downloads: [does not exist, skipping]"
          fi
          if [ -d "${{ github.workspace }}/vcpkg/packages" ]; then
            echo "  Removing packages..."
            rm -rf "${{ github.workspace }}/vcpkg/packages"
            CLEANED=1
          else
            echo "  packages: [does not exist, skipping]"
          fi
          if [ -d "${{ github.workspace }}/vcpkg-cache/packages" ]; then
            echo "  Removing cached packages directory copy..."
            rm -rf "${{ github.workspace }}/vcpkg-cache/packages"
            CLEANED=1
          fi
          if [ $CLEANED -eq 1 ]; then
            echo "Cleanup complete - directories removed"
          else
            echo "Cleanup complete - no directories to remove"
          fi

      - name: Measure vcpkg size after cleanup
        if: steps.vcpkg-cache.outputs.cache-hit != 'true'
        shell: bash
        run: |
          shopt -s nullglob
          echo "=== vcpkg directory sizes AFTER cleanup ==="
          du -sh "${{ github.workspace }}/vcpkg" || echo "vcpkg directory not found"
          echo ""
          echo "Breakdown by subdirectory:"
          du -sh "${{ github.workspace }}/vcpkg"/*/ 2>/dev/null || echo "No subdirectories found"
          echo ""
          echo "vcpkg-cache size:"
          du -sh "${{ github.workspace }}/vcpkg-cache" 2>/dev/null || echo "vcpkg-cache not found"
          echo ""
          echo "Total size that will be cached:"
          if [ -d "${{ github.workspace }}/vcpkg" ]; then
            echo "  vcpkg directory: $(du -sh "${{ github.workspace }}/vcpkg" | cut -f1)"
          else
            echo "  vcpkg directory: [not found]"
          fi
          if [ -d "${{ github.workspace }}/vcpkg-cache" ]; then
            echo "  vcpkg-cache directory: $(du -sh "${{ github.workspace }}/vcpkg-cache" | cut -f1)"
          else
            echo "  vcpkg-cache directory: [not found]"
          fi

      - name: Save vcpkg binary cache
        if: steps.vcpkg-cache.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          # NOTE: This caches both vcpkg/installed AND vcpkg-cache, which is redundant.
          # Binary cache (vcpkg-cache) contains pre-built packages that can restore vcpkg/installed.
          # This double-caching increases cache size significantly.
          #
          # TODO: Consider switching to one of these strategies:
          # 1. Cache only vcpkg-cache + vcpkg tools (smaller, relies on binary cache restore)
          # 2. Cache only vcpkg/installed (no binary cache, simpler but larger)
          path: |
            ${{ github.workspace }}/vcpkg
            ~/.cache/vcpkg
            ~/AppData/Local/vcpkg
            ${{ github.workspace }}/vcpkg-cache
          key: ${{ steps.vcpkg-cache.outputs.cache-primary-key }}

      - name: Configure and Build with CMake
        uses: lukka/run-cmake@v10
        with:
          configurePreset: 'windows-msvc-release'
          buildPreset: 'windows-msvc-release'
          # Enable verbose build output to see actual link commands
          buildPresetAdditionalArgs: "['--verbose']"
        env:
          VCPKG_BINARY_SOURCES: 'clear;files,${{ github.workspace }}/vcpkg-cache,readwrite'

      - name: Copy Qt and dependency DLLs next to executables
        shell: bash
        run: |
          set -euo pipefail
          shopt -s nullglob

          release_dir="${{ github.workspace }}/build/${{ matrix.cmake_preset }}/Release"
          qt_bin_dir="${{ env.Qt6_DIR }}/bin"
          qt_lib_dir="${{ env.Qt6_DIR }}/lib"
          vcpkg_bin_dir="${{ github.workspace }}/build/${{ matrix.cmake_preset }}/vcpkg_installed/x64-windows/bin"

          mkdir -p "$release_dir"

          if [ -f "${qt_lib_dir}/qscintilla2_qt6.dll" ]; then
            cp "${qt_lib_dir}/qscintilla2_qt6.dll" "$release_dir/"
          fi

          for dll in "${qt_bin_dir}"/*.dll; do
            cp "$dll" "$release_dir/"
          done

          if [ -d "$vcpkg_bin_dir" ]; then
            for dll in "${vcpkg_bin_dir}"/*.dll; do
              cp "$dll" "$release_dir/"
            done
          fi

          echo "Copied runtime DLLs into $release_dir"

          echo "--- OpenGL-related DLL presence check ---"
          if compgen -G "$release_dir/opengl32sw.dll" > /dev/null; then
            echo "  [OK] opengl32sw.dll present"
          else
            echo "  [MISSING] opengl32sw.dll"
          fi
          if compgen -G "$release_dir/libEGL*.dll" > /dev/null; then
            printf '  [OK] %s\n' "$release_dir"/libEGL*.dll | sed 's#.*/##'
          else
            echo "  [MISSING] libEGL*.dll"
          fi
          if compgen -G "$release_dir/libGLESv2*.dll" > /dev/null; then
            printf '  [OK] %s\n' "$release_dir"/libGLESv2*.dll | sed 's#.*/##'
          else
            echo "  [MISSING] libGLESv2*.dll"
          fi

          echo "--- Runtime directory listing (top 40 entries) ---"
          ls -1 "$release_dir" | head -40

      - name: Log Qt plugin folders resolved in Release directory
        shell: cmd
        run: |
          set "RELEASE_DIR=${{ github.workspace }}\build\${{ matrix.cmake_preset }}\Release"
          echo Runtime directory: %RELEASE_DIR%
          echo Available Qt platform plugins:
          if exist "%RELEASE_DIR%\platforms" (
            dir /b "%RELEASE_DIR%\platforms"
          ) else (
            echo   [platforms folder not found]
          )
          echo Available Qt angle plugins:
          if exist "%RELEASE_DIR%\opengl32sw.dll" (
            echo   opengl32sw.dll present
          ) else (
            echo   opengl32sw.dll missing
          )

      - name: Add Qt6 and QScintilla to PATH for tests
        shell: bash
        run: |
          echo "Adding Qt6 bin and lib directories to PATH..."
          echo "${{ env.Qt6_DIR }}/bin" >> $GITHUB_PATH
          echo "${{ env.Qt6_DIR }}/lib" >> $GITHUB_PATH
          echo "PATH updated for subsequent steps"

      - name: Run Tests
        env:
          QT_OPENGL: angle
          QT_ANGLE_PLATFORM: warp
          ANGLE_DEFAULT_PLATFORM: warp
          QT_DEBUG_PLUGINS: '1'
          PYTHONHOME: '${{ github.workspace }}\build\${{ matrix.cmake_preset }}\vcpkg_installed\x64-windows\tools\python3'
          PYTHONPATH: '${{ github.workspace }}\build\${{ matrix.cmake_preset }}\vcpkg_installed\x64-windows\tools\python3\Lib;${{ github.workspace }}\build\${{ matrix.cmake_preset }}\vcpkg_installed\x64-windows\tools\python3\Lib\site-packages'
        shell: bash
        run: |
          cd build/windows-msvc-release
          echo "=== Qt OpenGL diagnostics ==="
          echo "QT_OPENGL=$QT_OPENGL"
          echo "QT_ANGLE_PLATFORM=$QT_ANGLE_PLATFORM"
          echo "ANGLE_DEFAULT_PLATFORM=$ANGLE_DEFAULT_PLATFORM"
          echo "QT_DEBUG_PLUGINS=$QT_DEBUG_PLUGINS"
          echo "-- platforms/ folder contents --"
          ls -1 Release/platforms 2>/dev/null || echo "[platforms directory missing]"
          echo "-- opengl-related DLLs in Release/ --"
          ls -1 Release | grep -Ei 'opengl32sw|libegl|libglesv2' || echo "[no OpenGL DLLs matched]"
          echo "=== Running CTest ==="
          ctest -C Release -j4

      - name: Show sccache statistics
        if: always()
        shell: pwsh
        run: |
          sccache --show-stats

      - name: Save sccache cache
        if: always()
        uses: actions/cache/save@v4
        with:
          path: ${{ env.SCCACHE_DIR }}
          key: ${{ steps.sccache-cache.outputs.cache-primary-key }}
      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: Test Results (Windows MSVC ${{ matrix.build_type }})
          path: |
            build/${{ matrix.cmake_preset }}/Testing/Temporary/*_report.html
            build/${{ matrix.cmake_preset }}/Testing/Temporary/LastTest.log
          if-no-files-found: warn

      - name: Upload Build Artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: pythonscad-windows-msvc-${{ matrix.build_type }}
          path: |
            build/${{ matrix.cmake_preset }}/pythonscad.exe
            build/${{ matrix.cmake_preset }}/pythonscad-python.exe
          if-no-files-found: error
