name: Build and upload macOS build

on:
  release:
    types: [published]
  pull_request:
  workflow_dispatch:
    inputs:
      upload_to_release:
        description: 'Upload to latest release (leave empty for test builds)'
        required: false
        default: ''
      debug_enabled:
        type: boolean
        description: 'Run the build with tmate debugging enabled (https://github.com/marketplace/actions/debugging-with-tmate)'
        required: false
        default: false

jobs:
  build-macos:
    runs-on: macos-latest
    name: macOS Universal Binary
    # If it's not done in 120 minutes, something is wrong.
    timeout-minutes: 120
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          submodules: 'recursive'

      - name: Fetch tags for version detection
        run: |
          git fetch --unshallow --tags || git fetch --tags
          git describe --tags --always --dirty

      - name: Setup (detached) tmate session if enabled
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.debug_enabled }}
        uses: mxschmitt/action-tmate@v3
        timeout-minutes: 5
        with:
          detached: true
          limit-access-to-actor: true

      - name: Workaround for python3 linking issue
        run: |
          brew unlink python3
          brew link --overwrite python3

      - name: Install Homebrew prerequisites
        env:
          HOMEBREW_NO_AUTO_UPDATE: 1
          HOMEBREW_NO_INSTALLED_DEPENDENTS_CHECK: 1
        run: |
          brew install automake libtool cmake pkg-config wget meson python-packaging

      - name: Build dependencies
        env:
          NUMCPU: 4
        run: |
          # Build universal binaries (arm64 + x86_64) for deployment
          timeout 30m ./scripts/macosx-build-dependencies.sh -x -a || {
            echo "Dependency build timed out or failed"
            exit 1
          }

      - name: Build macOS Application
        env:
          NUMCPU: 4
        run: |
          # Run the same build script as CircleCI for consistency
          # This will create a universal binary DMG
          ./scripts/release-common.sh snapshot

      - name: Run macOS sanity check
        run: |
          # Validate the built application
          python3 ./scripts/macosx-sanity-check.py build_MACOSX/OpenSCAD.app

      - name: Prepare artifacts
        id: artifacts
        run: |
          mkdir -p /tmp/out

          # Find the generated DMG in build_MACOSX directory
          BUILD_DIR="build_MACOSX"

          echo "Looking for DMG in $BUILD_DIR..."

          # Find and copy DMG file
          DMG_FILE=$(find "$BUILD_DIR" -maxdepth 1 -name "*.dmg" | head -1)

          if [ -f "$DMG_FILE" ]; then
            basename_dmg=$(basename "$DMG_FILE")
            echo "Found DMG package: $DMG_FILE"
            cp -v "$DMG_FILE" /tmp/out/"$basename_dmg"

            # Generate checksums
            cd /tmp/out
            shasum -a 256 "$basename_dmg" > "$basename_dmg.sha256"
            shasum -a 512 "$basename_dmg" > "$basename_dmg.sha512"
            cd -

            echo "dmg_path=/tmp/out/$basename_dmg" >> $GITHUB_OUTPUT
            echo "dmg_name=$(basename "$basename_dmg" .dmg)" >> $GITHUB_OUTPUT
          else
            echo "ERROR: No DMG file found in $BUILD_DIR"
            exit 1
          fi

          # List what we have
          echo "Artifacts prepared:"
          ls -lh /tmp/out/

      - name: Upload DMG package
        if: steps.artifacts.outputs.dmg_path != ''
        uses: actions/upload-artifact@v5
        with:
          name: ${{ steps.artifacts.outputs.dmg_name }}
          path: ${{ steps.artifacts.outputs.dmg_path }}
          retention-days: 30

      - name: Upload checksums
        if: steps.artifacts.outputs.dmg_path != ''
        uses: actions/upload-artifact@v5
        with:
          name: ${{ steps.artifacts.outputs.dmg_name }}-checksums
          path: |
            /tmp/out/*.sha256
            /tmp/out/*.sha512
          retention-days: 30

      - name: Upload artifacts to release
        if: github.event_name == 'release' || github.event.inputs.upload_to_release != ''
        uses: softprops/action-gh-release@v2
        with:
          files: |
            /tmp/out/*.dmg
            /tmp/out/*.sha256
            /tmp/out/*.sha512
          tag_name: ${{ github.event.release.tag_name || github.event.inputs.upload_to_release }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup (attached) tmate session if enabled
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.debug_enabled }}
        uses: mxschmitt/action-tmate@v3
