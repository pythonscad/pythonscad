name: Build and upload macOS build

on:
  release:
    types: [published]
  pull_request:
  workflow_dispatch:
    inputs:
      upload_to_release:
        description: 'Upload to latest release (leave empty for test builds)'
        required: false
        default: ''
      debug_enabled:
        type: boolean
        description: 'Run the build with tmate debugging enabled (https://github.com/marketplace/actions/debugging-with-tmate)'
        required: false
        default: false

jobs:
  build-macos:
    runs-on: macos-latest
    name: macOS Universal Binary
    # If it's not done in 120 minutes, something is wrong.
    timeout-minutes: 120
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          submodules: 'recursive'

      - name: Fetch tags for version detection
        run: |
          git fetch --unshallow --tags || git fetch --tags
          git describe --tags --always --dirty

      - name: Setup (detached) tmate session if enabled
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.debug_enabled }}
        uses: mxschmitt/action-tmate@v3
        timeout-minutes: 5
        with:
          detached: true
          limit-access-to-actor: true

      - name: Workaround for python3 linking issue
        run: |
          brew unlink python3
          brew link --overwrite python3

      - name: Install Homebrew prerequisites
        env:
          HOMEBREW_NO_AUTO_UPDATE: 1
          HOMEBREW_NO_INSTALLED_DEPENDENTS_CHECK: 1
        run: |
          brew install automake libtool cmake pkg-config wget meson python-packaging openssl@3

      - name: Restore cached dependencies
        id: cache-deps
        uses: actions/cache@v4
        with:
          path: ${{ github.workspace }}/../libraries/install
          key: macos-libs-${{ runner.arch }}-${{ hashFiles('scripts/macosx-build-dependencies.sh') }}
          restore-keys: |
            macos-libs-${{ runner.arch }}-

      - name: Build dependencies
        id: build-deps
        env:
          NUMCPU: 4
          OPENSCAD_LIBRARIES: ${{ github.workspace }}/../libraries/install
          PKG_CONFIG_PATH: ${{ github.workspace }}/../libraries/install/lib/pkgconfig
          DYLD_LIBRARY_PATH: ${{ github.workspace }}/../libraries/install/lib
          DYLD_FRAMEWORK_PATH: ${{ github.workspace }}/../libraries/install/lib
        run: |
          # Build universal binaries (arm64 + x86_64) for deployment
          # Add library paths to PATH for dependency discovery
          export PATH="${OPENSCAD_LIBRARIES}/bin:$PATH"
          ./scripts/macosx-build-dependencies.sh -x -a -d

      - name: Clean up build artifacts
        if: steps.build-deps.outcome == 'success'
        run: |
          # Remove build directories and source files to reduce cache size
          # Keep only the installed libraries
          LIBS_DIR="${{ github.workspace }}/../libraries"
          if [ -d "$LIBS_DIR/src" ]; then
            echo "Cleaning up source directory..."
            rm -rf "$LIBS_DIR/src"
          fi
          if [ -d "$LIBS_DIR/install" ]; then
            echo "Cache size before cleanup:"
            du -sh "$LIBS_DIR/install"
            # Remove unnecessary files from install directory
            find "$LIBS_DIR/install" -name "*.a" -delete  # Static libraries
            find "$LIBS_DIR/install" -name "*.la" -delete  # Libtool files
            rm -rf "$LIBS_DIR/install/share/man"  # Man pages
            rm -rf "$LIBS_DIR/install/share/doc"  # Documentation
            echo "Cache size after cleanup:"
            du -sh "$LIBS_DIR/install"
          fi

      - name: Save dependency cache
        if: steps.build-deps.outcome == 'success'
        uses: actions/cache/save@v4
        with:
          path: ${{ github.workspace }}/../libraries/install
          key: macos-libs-${{ runner.arch }}-${{ hashFiles('scripts/macosx-build-dependencies.sh') }}-${{ github.run_id }}

      - name: Build macOS Application
        env:
          NUMCPU: 4
        run: |
          # Run the same build script as CircleCI for consistency
          # This will create a universal binary .app bundle
          ./scripts/release-common.sh snapshot

      - name: Determine app bundle name
        id: appname
        run: |
          # Find the actual .app bundle name (could be pythonscad.app or pythonscad-snapshot.app)
          APP_BUNDLE=$(find build_MACOSX -maxdepth 1 -name "*.app" -type d | head -1)
          if [ -z "$APP_BUNDLE" ]; then
            echo "ERROR: No .app bundle found in build_MACOSX"
            exit 1
          fi
          echo "app_bundle=$APP_BUNDLE" >> $GITHUB_OUTPUT
          echo "Found app bundle: $APP_BUNDLE"

      - name: Run macOS sanity check
        run: |
          # Validate the built application
          python3 ./scripts/macosx-sanity-check.py ${{ steps.appname.outputs.app_bundle }}

      - name: Create DMG
        id: dmg
        run: |
          # Get version from git
          VERSION=$(git describe --tags --always --dirty)
          APP_BUNDLE="${{ steps.appname.outputs.app_bundle }}"
          DMG_NAME="PythonSCAD-${VERSION}.dmg"

          # Create DMG using hdiutil (same as CircleCI)
          hdiutil create -volname "PythonSCAD" -srcfolder "$APP_BUNDLE" -ov -format UDZO "build_MACOSX/$DMG_NAME"

          echo "dmg_file=build_MACOSX/$DMG_NAME" >> $GITHUB_OUTPUT
          echo "Created DMG: $DMG_NAME"

      - name: Prepare artifacts
        id: artifacts
        run: |
          mkdir -p /tmp/out

          DMG_FILE="${{ steps.dmg.outputs.dmg_file }}"
          basename_dmg=$(basename "$DMG_FILE")

          echo "Copying DMG: $DMG_FILE"
          cp -v "$DMG_FILE" /tmp/out/"$basename_dmg"

          # Generate checksums
          cd /tmp/out
          shasum -a 256 "$basename_dmg" > "$basename_dmg.sha256"
          shasum -a 512 "$basename_dmg" > "$basename_dmg.sha512"
          cd -

          echo "dmg_path=/tmp/out/$basename_dmg" >> $GITHUB_OUTPUT
          echo "dmg_name=$(basename "$basename_dmg" .dmg)" >> $GITHUB_OUTPUT

          # List what we have
          echo "Artifacts prepared:"
          ls -lh /tmp/out/

      - name: Upload DMG package
        if: steps.artifacts.outputs.dmg_path != ''
        uses: actions/upload-artifact@v5
        with:
          name: ${{ steps.artifacts.outputs.dmg_name }}
          path: ${{ steps.artifacts.outputs.dmg_path }}
          retention-days: 30

      - name: Upload checksums
        if: steps.artifacts.outputs.dmg_path != ''
        uses: actions/upload-artifact@v5
        with:
          name: ${{ steps.artifacts.outputs.dmg_name }}-checksums
          path: |
            /tmp/out/*.sha256
            /tmp/out/*.sha512
          retention-days: 30

      - name: Upload artifacts to release
        if: github.event_name == 'release' || github.event.inputs.upload_to_release != ''
        uses: softprops/action-gh-release@v2
        with:
          files: |
            /tmp/out/*.dmg
            /tmp/out/*.sha256
            /tmp/out/*.sha512
          tag_name: ${{ github.event.release.tag_name || github.event.inputs.upload_to_release }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup (attached) tmate session if enabled
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.debug_enabled }}
        uses: mxschmitt/action-tmate@v3
