# PythonSCAD MSVC Build Script for Local Windows Development
# This script replicates the GitHub Actions MSVC workflow for local building
#
# This script will automatically install missing prerequisites using winget
# Run with -InstallPrerequisites to install all required software automatically

param(
    [string]$SourceDir = "",  # If empty, will auto-detect repository root
    [string]$BuildDir = "",   # If empty, will use $SourceDir\build\windows-msvc-release
    [string]$Qt6Version = "6.10.0",
    [string]$Qt6Path = "",  # If empty, will try to detect or prompt
    [switch]$InstallPrerequisites,  # Install missing prerequisites automatically
    [switch]$SkipQScintilla,
    [switch]$SkipVcpkg,
    [switch]$SkipBuild,
    [switch]$RunTests,
    [switch]$CleanBuild
)

$ErrorActionPreference = "Stop"

# Auto-detect repository root if not specified
if ([string]::IsNullOrEmpty($SourceDir)) {
    $scriptDir = Split-Path -Parent $MyInvocation.MyCommand.Path
    # Check if we're in the scripts directory
    if ((Split-Path -Leaf $scriptDir) -eq "scripts") {
        $SourceDir = Split-Path -Parent $scriptDir
    } else {
        $SourceDir = $scriptDir
    }
}

# Set BuildDir if not specified
if ([string]::IsNullOrEmpty($BuildDir)) {
    $BuildDir = "$SourceDir\build\windows-msvc-release"
}

Write-Host "========================================" -ForegroundColor Cyan
Write-Host "PythonSCAD MSVC Build Script" -ForegroundColor Cyan
Write-Host "========================================" -ForegroundColor Cyan
Write-Host ""

# Function to check if a command exists
function Test-Command {
    param($Command)
    $null = Get-Command $Command -ErrorAction SilentlyContinue
    return $?
}

# Function to install a package using winget
function Install-WithWinget {
    param(
        [string]$PackageId,
        [string]$PackageName
    )

    Write-Host "Installing $PackageName via winget..." -ForegroundColor Yellow
    winget install --id $PackageId --silent --accept-source-agreements --accept-package-agreements

    if ($LASTEXITCODE -eq 0) {
        Write-Host "✓ $PackageName installed successfully" -ForegroundColor Green
        return $true
    } else {
        Write-Host "⚠ Failed to install $PackageName (exit code: $LASTEXITCODE)" -ForegroundColor Yellow
        return $false
    }
}

# Install prerequisites if requested
if ($InstallPrerequisites) {
    Write-Host "========================================" -ForegroundColor Cyan
    Write-Host "Installing Prerequisites" -ForegroundColor Cyan
    Write-Host "========================================" -ForegroundColor Cyan
    Write-Host ""

    # Check if winget is available
    if (-not (Test-Command winget)) {
        Write-Host "ERROR: winget is not available on this system." -ForegroundColor Red
        Write-Host "winget is included with Windows 10 1809+ and Windows 11." -ForegroundColor Yellow
        Write-Host "Please update Windows or install App Installer from the Microsoft Store." -ForegroundColor Yellow
        exit 1
    }

    Write-Host "Using winget to install missing prerequisites..." -ForegroundColor Yellow
    Write-Host ""

    # Install Git
    if (-not (Test-Command git)) {
        Install-WithWinget -PackageId "Git.Git" -PackageName "Git"
    } else {
        Write-Host "✓ Git already installed" -ForegroundColor Green
    }

    # Install CMake
    if (-not (Test-Command cmake)) {
        Install-WithWinget -PackageId "Kitware.CMake" -PackageName "CMake"
    } else {
        Write-Host "✓ CMake already installed" -ForegroundColor Green
    }

    # Install Python
    if (-not (Test-Command python)) {
        Install-WithWinget -PackageId "Python.Python.3.11" -PackageName "Python 3.11"
    } else {
        Write-Host "✓ Python already installed" -ForegroundColor Green
    }

    # Install Visual Studio Build Tools (or check if VS is installed)
    $vsPath = "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe"
    $vsInstalled = $false

    if (Test-Path $vsPath) {
        $vs = & $vsPath -latest -products * -requires Microsoft.VisualStudio.Component.VC.Tools.x86.x64 -property installationPath
        if ($vs) {
            Write-Host "✓ Visual Studio with C++ tools already installed at: $vs" -ForegroundColor Green
            $vsInstalled = $true
        }
    }

    if (-not $vsInstalled) {
        Write-Host "Visual Studio 2022 with C++ tools not found." -ForegroundColor Yellow
        Write-Host "You have two options:" -ForegroundColor Yellow
        Write-Host "  1. Install Visual Studio 2022 Community (full IDE)" -ForegroundColor Gray
        Write-Host "  2. Install Visual Studio 2022 Build Tools (command-line only)" -ForegroundColor Gray
        Write-Host ""
        $vsChoice = Read-Host "Enter choice (1 or 2, or S to skip)"

        if ($vsChoice -eq "1") {
            Write-Host "Installing Visual Studio 2022 Community..." -ForegroundColor Yellow
            Write-Host "Note: You'll need to manually select 'Desktop development with C++' workload during installation." -ForegroundColor Yellow
            winget install --id Microsoft.VisualStudio.2022.Community --silent --override "--quiet --wait --add Microsoft.VisualStudio.Workload.NativeDesktop --includeRecommended"
        } elseif ($vsChoice -eq "2") {
            Write-Host "Installing Visual Studio 2022 Build Tools..." -ForegroundColor Yellow
            winget install --id Microsoft.VisualStudio.2022.BuildTools --silent --override "--quiet --wait --add Microsoft.VisualStudio.Workload.VCTools --includeRecommended"
        } else {
            Write-Host "⚠ Skipping Visual Studio installation" -ForegroundColor Yellow
        }
    }

    # Install MSYS2
    if (-not (Test-Path "C:\msys64\usr\bin\bash.exe")) {
        Install-WithWinget -PackageId "MSYS2.MSYS2" -PackageName "MSYS2"
    } else {
        Write-Host "✓ MSYS2 already installed" -ForegroundColor Green
    }

    # Install Qt6
    if ([string]::IsNullOrEmpty($Qt6Path)) {
        Write-Host ""
        Write-Host "Qt6 Installation:" -ForegroundColor Yellow
        Write-Host "Qt6 needs to be installed manually via the official Qt installer." -ForegroundColor Yellow
        Write-Host "Please install Qt 6.10.0 with the following components:" -ForegroundColor Yellow
        Write-Host "  - MSVC 2022 64-bit" -ForegroundColor Gray
        Write-Host "  - Qt 5 Compatibility Module" -ForegroundColor Gray
        Write-Host "  - Qt Multimedia" -ForegroundColor Gray
        Write-Host ""
        Write-Host "Download from: https://www.qt.io/download-qt-installer" -ForegroundColor Cyan
        Write-Host ""

        $installQt = Read-Host "Press Enter after installing Qt6, or S to skip"
        if ($installQt -ne "S" -and $installQt -ne "s") {
            Write-Host "Continuing with Qt6 installed..." -ForegroundColor Green
        }
    }

    Write-Host ""
    Write-Host "========================================" -ForegroundColor Cyan
    Write-Host "Prerequisites Installation Complete" -ForegroundColor Cyan
    Write-Host "========================================" -ForegroundColor Cyan
    Write-Host ""
    Write-Host "NOTE: You may need to restart your terminal or computer for PATH changes to take effect." -ForegroundColor Yellow
    Write-Host ""

    $restart = Read-Host "Do you want to restart PowerShell now? (Y/N)"
    if ($restart -eq "Y" -or $restart -eq "y") {
        Write-Host "Please close this window and open a new PowerShell window, then run the script again without -InstallPrerequisites" -ForegroundColor Yellow
        exit 0
    }
}

# Check prerequisites
Write-Host "Checking prerequisites..." -ForegroundColor Yellow

if (-not (Test-Command cmake)) {
    Write-Host "ERROR: CMake not found. Please install CMake 3.20+" -ForegroundColor Red
    exit 1
}

if (-not (Test-Command git)) {
    Write-Host "ERROR: Git not found. Please install Git" -ForegroundColor Red
    exit 1
}

if (-not (Test-Command python)) {
    Write-Host "ERROR: Python not found. Please install Python 3.11+" -ForegroundColor Red
    exit 1
}

Write-Host "✓ Prerequisites check passed" -ForegroundColor Green
Write-Host ""

# Initialize submodules
Write-Host "Initializing Git submodules..." -ForegroundColor Yellow
git submodule update --init --recursive
Write-Host "✓ Submodules initialized" -ForegroundColor Green
Write-Host ""

# Setup Visual Studio environment
Write-Host "Setting up Visual Studio environment..." -ForegroundColor Yellow
$vswhere = "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe"
if (Test-Path $vswhere) {
    $vsPath = & $vswhere -latest -products * -requires Microsoft.VisualStudio.Component.VC.Tools.x86.x64 -property installationPath
    if ($vsPath) {
        $vcvarsPath = "$vsPath\VC\Auxiliary\Build\vcvars64.bat"
        if (Test-Path $vcvarsPath) {
            Write-Host "Found Visual Studio at: $vsPath" -ForegroundColor Green
            # Import VS environment variables using full path to Windows cmd.exe
            & $env:ComSpec /c """$vcvarsPath"" && set" | ForEach-Object {
                if ($_ -match "^([^=]+)=(.*)$") {
                    [System.Environment]::SetEnvironmentVariable($matches[1], $matches[2], "Process")
                }
            }
        }
    }
}
Write-Host "✓ Visual Studio environment configured" -ForegroundColor Green
Write-Host ""

# Find or prompt for Qt6
if ([string]::IsNullOrEmpty($Qt6Path)) {
    Write-Host "Searching for Qt6 installation..." -ForegroundColor Yellow

    # Common Qt installation paths
    $possiblePaths = @(
        "C:\Qt\$Qt6Version\msvc2022_64",
        "C:\Qt\$Qt6Version\msvc2019_64",
        "$env:USERPROFILE\Qt\$Qt6Version\msvc2022_64",
        "D:\Qt\$Qt6Version\msvc2022_64"
    )

    foreach ($path in $possiblePaths) {
        if (Test-Path "$path\bin\qmake.exe") {
            $Qt6Path = $path
            Write-Host "Found Qt6 at: $Qt6Path" -ForegroundColor Green
            break
        }
    }

    if ([string]::IsNullOrEmpty($Qt6Path)) {
        Write-Host "Qt6 not found automatically. Please enter Qt6 installation path:" -ForegroundColor Yellow
        Write-Host "Example: C:\Qt\6.10.0\msvc2022_64" -ForegroundColor Gray
        $Qt6Path = Read-Host "Qt6 Path"

        if (-not (Test-Path "$Qt6Path\bin\qmake.exe")) {
            Write-Host "ERROR: Invalid Qt6 path. qmake.exe not found at $Qt6Path\bin" -ForegroundColor Red
            exit 1
        }
    }
}

$env:Qt6_DIR = $Qt6Path
$env:QT_ROOT_DIR = $Qt6Path
$env:CMAKE_PREFIX_PATH = $Qt6Path
$env:PATH = "$Qt6Path\bin;$env:PATH"
Write-Host "✓ Qt6 configured: $Qt6Path" -ForegroundColor Green
Write-Host ""

# Build QScintilla
if (-not $SkipQScintilla) {
    $qsciLib = "$Qt6Path\lib\qscintilla2_qt6.lib"
    $qsciDll = "$Qt6Path\lib\qscintilla2_qt6.dll"
    $qsciInclude = "$Qt6Path\include\Qsci"

    if ((Test-Path $qsciLib) -and (Test-Path $qsciDll) -and (Test-Path $qsciInclude)) {
        Write-Host "QScintilla already installed, skipping build" -ForegroundColor Green
    } else {
        Write-Host "Building QScintilla from source..." -ForegroundColor Yellow

        $qsciUrl = "https://www.riverbankcomputing.com/static/Downloads/QScintilla/2.14.1/QScintilla_src-2.14.1.tar.gz"
        $qsciArchive = "$env:TEMP\qscintilla.tar.gz"

        Write-Host "  Downloading QScintilla..."
        Invoke-WebRequest -Uri $qsciUrl -OutFile $qsciArchive

        Write-Host "  Extracting QScintilla..."
        tar -xzf $qsciArchive -C $env:TEMP

        Push-Location "$env:TEMP\QScintilla_src-2.14.1\src"
        try {
            Write-Host "  Building QScintilla..."
            qmake qscintilla.pro
            nmake

            Write-Host "  Installing QScintilla..."
            nmake install

            Write-Host "✓ QScintilla built and installed successfully" -ForegroundColor Green
        } finally {
            Pop-Location
            Remove-Item -Recurse -Force "$env:TEMP\QScintilla_src-2.14.1" -ErrorAction SilentlyContinue
            Remove-Item -Force $qsciArchive -ErrorAction SilentlyContinue
        }
    }
    Write-Host ""
}

# Setup MSYS2 (for flex and bison)
Write-Host "Checking MSYS2..." -ForegroundColor Yellow
$msys2Path = "C:\msys64\usr\bin"
if (Test-Path $msys2Path) {
    $env:PATH = "$msys2Path;$env:PATH"

    if (-not (Test-Path "$msys2Path\flex.exe") -or -not (Test-Path "$msys2Path\bison.exe")) {
        Write-Host "  Installing flex and bison via pacman..."
        & C:\msys64\usr\bin\pacman.exe -Sy --noconfirm flex bison
    }
    Write-Host "✓ MSYS2 configured (flex and bison available)" -ForegroundColor Green
} else {
    Write-Host "WARNING: MSYS2 not found at $msys2Path" -ForegroundColor Yellow
    Write-Host "         You may need to install flex and bison manually" -ForegroundColor Yellow
}
Write-Host ""

# Install Python dependencies
Write-Host "Installing Python dependencies..." -ForegroundColor Yellow
python -m pip install --upgrade pip
pip install bsdiff4 numpy pillow
Write-Host "✓ Python dependencies installed" -ForegroundColor Green
Write-Host ""

# Setup vcpkg
if (-not $SkipVcpkg) {
    Write-Host "Setting up vcpkg..." -ForegroundColor Yellow

    $vcpkgDir = "$SourceDir\vcpkg"
    $vcpkgExe = "$vcpkgDir\vcpkg.exe"

    # Clone vcpkg if it doesn't exist
    if (-not (Test-Path $vcpkgDir)) {
        Write-Host "  Cloning vcpkg from GitHub..."
        git clone https://github.com/Microsoft/vcpkg.git $vcpkgDir

        # Checkout specific commit used in CI (optional but ensures consistency)
        Push-Location $vcpkgDir
        try {
            git checkout 74e6536215718009aae747d86d84b78376bf9e09
        } finally {
            Pop-Location
        }
    }

    # Bootstrap vcpkg if not already done
    if (-not (Test-Path $vcpkgExe)) {
        Write-Host "  Bootstrapping vcpkg..."
        Push-Location $vcpkgDir
        try {
            .\bootstrap-vcpkg.bat -disableMetrics
        } finally {
            Pop-Location
        }
    }

    Write-Host "  Installing vcpkg dependencies from vcpkg.json..."
    $env:VCPKG_ROOT = $vcpkgDir

    # Change to source directory so vcpkg can find vcpkg.json
    Push-Location $SourceDir
    try {
        & $vcpkgExe install --triplet x64-windows
    } finally {
        Pop-Location
    }

    Write-Host "✓ vcpkg dependencies installed" -ForegroundColor Green
    Write-Host ""
}

# Clean build directory if requested
if ($CleanBuild -and (Test-Path $BuildDir)) {
    Write-Host "Cleaning build directory..." -ForegroundColor Yellow
    Remove-Item -Recurse -Force $BuildDir
    Write-Host "✓ Build directory cleaned" -ForegroundColor Green
    Write-Host ""
}

# Configure and build with CMake
if (-not $SkipBuild) {
    Write-Host "Configuring CMake..." -ForegroundColor Yellow

    if (-not (Test-Path $BuildDir)) {
        New-Item -ItemType Directory -Path $BuildDir -Force | Out-Null
    }

    cmake --preset windows-msvc-release

    Write-Host "✓ CMake configuration complete" -ForegroundColor Green
    Write-Host ""

    Write-Host "Building PythonSCAD..." -ForegroundColor Yellow
    cmake --build --preset windows-msvc-release --verbose

    Write-Host "✓ Build complete" -ForegroundColor Green
    Write-Host ""
}

# Run tests if requested
if ($RunTests) {
    Write-Host "Running tests..." -ForegroundColor Yellow
    Push-Location "$BuildDir\tests"
    try {
        ctest -C Release -j4 --output-on-failure
        Write-Host "✓ Tests complete" -ForegroundColor Green
    } finally {
        Pop-Location
    }
    Write-Host ""
}

# Summary
Write-Host "========================================" -ForegroundColor Cyan
Write-Host "Build Summary" -ForegroundColor Cyan
Write-Host "========================================" -ForegroundColor Cyan
Write-Host "Source Directory: $SourceDir" -ForegroundColor White
Write-Host "Build Directory:  $BuildDir" -ForegroundColor White
Write-Host "Qt6 Path:         $Qt6Path" -ForegroundColor White
Write-Host ""

if (Test-Path "$BuildDir\Release\pythonscad.exe") {
    Write-Host "✓ Executable: $BuildDir\Release\pythonscad.exe" -ForegroundColor Green
} else {
    Write-Host "⚠ Executable not found (build may have failed)" -ForegroundColor Yellow
}

Write-Host ""
Write-Host "To run tests manually:" -ForegroundColor Yellow
Write-Host "  cd $BuildDir\tests" -ForegroundColor Gray
Write-Host "  ctest -C Release --output-on-failure" -ForegroundColor Gray
Write-Host ""
Write-Host "To run PythonSCAD:" -ForegroundColor Yellow
Write-Host "  $BuildDir\Release\pythonscad.exe" -ForegroundColor Gray
Write-Host ""
